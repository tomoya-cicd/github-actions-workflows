# Xcode macOS CI/CD Reusable Workflow
# Storyboard/SwiftUI Ã— CocoaPods/SPM å…¨å¯¾å¿œ
# ã‚³ãƒ¼ãƒ‰ç½²åã‚ªãƒ—ã‚·ãƒ§ãƒ³å¯¾å¿œ

name: Xcode macOS CI/CD

on:
  workflow_call:
    inputs:
      # UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
      ui-framework:
        description: 'UI framework (storyboard or swiftui)'
        required: false
        type: string
        default: 'swiftui'
      
      # ä¾å­˜é–¢ä¿‚ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼
      dependency-manager:
        description: 'Dependency manager (cocoapods or spm)'
        required: false
        type: string
        default: 'spm'
      
      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š
      project-path:
        description: 'Path to .xcodeproj or .xcworkspace'
        required: true
        type: string
      
      scheme:
        description: 'Xcode scheme name'
        required: true
        type: string
      
      # ãƒ“ãƒ«ãƒ‰è¨­å®š
      configuration:
        description: 'Build configuration (Debug or Release)'
        required: false
        type: string
        default: 'Release'
      
      # ã‚³ãƒ¼ãƒ‰ç½²åè¨­å®š
      enable-code-signing:
        description: 'Enable code signing'
        required: false
        type: boolean
        default: false
      
      signing-identity:
        description: 'Code signing identity (e.g., "Developer ID Application: Your Name")'
        required: false
        type: string
        default: '-'
      
      development-team:
        description: 'Development team ID'
        required: false
        type: string
        default: ''
      
      export-method:
        description: 'Export method (development, developer-id, app-store)'
        required: false
        type: string
        default: 'development'
      
      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run-tests:
        description: 'Run unit tests'
        required: false
        type: boolean
        default: true
      
      # DMGä½œæˆ
      create-dmg:
        description: 'Create DMG installer'
        required: false
        type: boolean
        default: true
      
      # Xcode ãƒãƒ¼ã‚¸ãƒ§ãƒ³
      xcode-version:
        description: 'Xcode version (e.g., latest-stable, 15.2, 16.0)'
        required: false
        type: string
        default: 'latest-stable'
      
      # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
      working-directory:
        required: false
        type: string
        default: '.'
      
      # ãƒ©ãƒ³ãƒŠãƒ¼
      runs-on:
        required: false
        type: string
        default: 'self-hosted'
    
    secrets:
      GITHUB_TOKEN:
        required: false

jobs:
  # ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  setup:
    name: Setup Build Environment
    runs-on: ${{ inputs.runs-on }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    outputs:
      project-type: ${{ steps.detect.outputs.project-type }}
      app-name: ${{ steps.detect.outputs.app-name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ inputs.xcode-version }}
      
      - name: Detect project type
        id: detect
        run: |
          echo "## ðŸ”¨ Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **UI Framework**: ${{ inputs.ui-framework }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Manager**: ${{ inputs.dependency-manager }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Signing**: ${{ inputs.enable-code-signing && 'Enabled' || 'Disabled' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Xcode**: $(xcodebuild -version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS**: $(sw_vers -productVersion)" >> $GITHUB_STEP_SUMMARY
          echo "- **Swift**: $(swift --version | head -1)" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¿ã‚¤ãƒ—åˆ¤å®š
          if [[ "${{ inputs.project-path }}" == *.xcworkspace ]]; then
            echo "project-type=workspace" >> $GITHUB_OUTPUT
          else
            echo "project-type=project" >> $GITHUB_OUTPUT
          fi
          
          # ã‚¢ãƒ—ãƒªåæŠ½å‡º
          APP_NAME="${{ inputs.scheme }}"
          echo "app-name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "- **App Name**: $APP_NAME" >> $GITHUB_STEP_SUMMARY
      
      - name: Show environment
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### System Information" >> $GITHUB_STEP_SUMMARY
          echo "- macOS SDK: $(xcrun --show-sdk-version)" >> $GITHUB_STEP_SUMMARY
          echo "- Ruby: $(ruby --version | cut -d' ' -f1-2)" >> $GITHUB_STEP_SUMMARY
  
  # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  dependencies:
    name: Install Dependencies
    runs-on: ${{ inputs.runs-on }}
    needs: setup
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ inputs.xcode-version }}
      
      - name: Install CocoaPods dependencies
        if: inputs.dependency-manager == 'cocoapods'
        run: |
          echo "## ðŸ“¦ CocoaPods Dependencies" >> $GITHUB_STEP_SUMMARY
          
          # CocoaPodsã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo gem install cocoapods
          echo "- **CocoaPods**: $(pod --version)" >> $GITHUB_STEP_SUMMARY
          
          # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          pod install --repo-update
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installed Pods" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          pod list 2>/dev/null | head -20 || echo "No pods listed"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Resolve SPM dependencies
        if: inputs.dependency-manager == 'spm'
        run: |
          echo "## ðŸ“¦ Swift Package Manager" >> $GITHUB_STEP_SUMMARY
          
          # SPMä¾å­˜é–¢ä¿‚è§£æ±º
          if [ "${{ needs.setup.outputs.project-type }}" = "workspace" ]; then
            xcodebuild -resolvePackageDependencies -workspace ${{ inputs.project-path }} -scheme ${{ inputs.scheme }}
          else
            xcodebuild -resolvePackageDependencies -project ${{ inputs.project-path }} -scheme ${{ inputs.scheme }}
          fi
          
          # Package.resolvedè¡¨ç¤º
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resolved Packages" >> $GITHUB_STEP_SUMMARY
          
          RESOLVED_FILE="${{ inputs.project-path }}/project.xcworkspace/xcshareddata/swiftpm/Package.resolved"
          if [ -f "$RESOLVED_FILE" ]; then
            echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
            cat "$RESOLVED_FILE" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "No Package.resolved found" >> $GITHUB_STEP_SUMMARY
          fi
  
  # ãƒ“ãƒ«ãƒ‰
  build:
    name: Build macOS App
    runs-on: ${{ inputs.runs-on }}
    needs: [setup, dependencies]
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ inputs.xcode-version }}
      
      - name: Install CocoaPods (if needed)
        if: inputs.dependency-manager == 'cocoapods'
        run: |
          sudo gem install cocoapods
          pod install --repo-update
      
      - name: Resolve SPM (if needed)
        if: inputs.dependency-manager == 'spm'
        run: |
          if [ "${{ needs.setup.outputs.project-type }}" = "workspace" ]; then
            xcodebuild -resolvePackageDependencies -workspace ${{ inputs.project-path }} -scheme ${{ inputs.scheme }}
          else
            xcodebuild -resolvePackageDependencies -project ${{ inputs.project-path }} -scheme ${{ inputs.scheme }}
          fi
      
      - name: Build macOS app
        run: |
          echo "## ðŸ”¨ Building macOS App" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ“ãƒ«ãƒ‰ã‚³ãƒžãƒ³ãƒ‰æ§‹ç¯‰
          if [ "${{ needs.setup.outputs.project-type }}" = "workspace" ]; then
            BUILD_CMD="-workspace ${{ inputs.project-path }}"
          else
            BUILD_CMD="-project ${{ inputs.project-path }}"
          fi
          
          # SwiftUIå›ºæœ‰ã®ãƒ•ãƒ©ã‚°
          if [ "${{ inputs.ui-framework }}" = "swiftui" ]; then
            SWIFT_FLAGS="SWIFT_COMPILATION_MODE=wholemodule SWIFT_OPTIMIZATION_LEVEL=-O"
          else
            SWIFT_FLAGS=""
          fi
          
          # ç½²åè¨­å®š
          if [ "${{ inputs.enable-code-signing }}" = "true" ]; then
            SIGNING_FLAGS="CODE_SIGN_IDENTITY=\"${{ inputs.signing-identity }}\""
            if [ -n "${{ inputs.development-team }}" ]; then
              SIGNING_FLAGS="$SIGNING_FLAGS DEVELOPMENT_TEAM=\"${{ inputs.development-team }}\""
            fi
          else
            SIGNING_FLAGS="CODE_SIGN_IDENTITY=\"-\" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO"
          fi
          
          # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          xcodebuild \
            $BUILD_CMD \
            -scheme ${{ inputs.scheme }} \
            -sdk macosx \
            -configuration ${{ inputs.configuration }} \
            -archivePath build/${{ needs.setup.outputs.app-name }}.xcarchive \
            clean archive \
            $SWIFT_FLAGS \
            $SIGNING_FLAGS \
            ONLY_ACTIVE_ARCH=NO \
            | xcpretty || true
          
          echo "âœ… Build completed" >> $GITHUB_STEP_SUMMARY
      
      - name: Export .app bundle
        run: |
          # exportOptions.plistä½œæˆ
          cat > exportOptions.plist <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>${{ inputs.export-method }}</string>
EOF
          
          # ç½²åãŒæœ‰åŠ¹ãªå ´åˆã®è¿½åŠ è¨­å®š
          if [ "${{ inputs.enable-code-signing }}" = "true" ]; then
            cat >> exportOptions.plist <<EOF
    <key>signingStyle</key>
    <string>manual</string>
EOF
            if [ -n "${{ inputs.development-team }}" ]; then
              cat >> exportOptions.plist <<EOF
    <key>teamID</key>
    <string>${{ inputs.development-team }}</string>
EOF
            fi
          fi
          
          cat >> exportOptions.plist <<EOF
    <key>stripSwiftSymbols</key>
    <true/>
</dict>
</plist>
EOF
          
          # Export
          xcodebuild \
            -exportArchive \
            -archivePath build/${{ needs.setup.outputs.app-name }}.xcarchive \
            -exportPath dist \
            -exportOptionsPlist exportOptions.plist
      
      - name: Verify app bundle
        run: |
          APP_PATH="dist/${{ needs.setup.outputs.app-name }}.app"
          
          echo "## ðŸ“¦ App Bundle Information" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "$APP_PATH" ]; then
            # ã‚µã‚¤ã‚º
            APP_SIZE=$(du -sh "$APP_PATH" | cut -f1)
            echo "- **Size**: $APP_SIZE" >> $GITHUB_STEP_SUMMARY
            
            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±
            VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" "$APP_PATH/Contents/Info.plist" 2>/dev/null || echo "N/A")
            BUILD=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$APP_PATH/Contents/Info.plist" 2>/dev/null || echo "N/A")
            BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" "$APP_PATH/Contents/Info.plist" 2>/dev/null || echo "N/A")
            
            echo "- **Version**: $VERSION ($BUILD)" >> $GITHUB_STEP_SUMMARY
            echo "- **Bundle ID**: $BUNDLE_ID" >> $GITHUB_STEP_SUMMARY
            
            # ç½²åæƒ…å ±
            if [ "${{ inputs.enable-code-signing }}" = "true" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Code Signature" >> $GITHUB_STEP_SUMMARY
              codesign -dv "$APP_PATH" 2>&1 | head -5 >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ Signature verification failed" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Signing**: Disabled (development build)" >> $GITHUB_STEP_SUMMARY
            fi
            
            # SwiftUIã®å ´åˆã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ç¢ºèª
            if [ "${{ inputs.ui-framework }}" = "swiftui" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### SwiftUI Frameworks" >> $GITHUB_STEP_SUMMARY
              ls "$APP_PATH/Contents/Frameworks/" 2>/dev/null | grep -i swift >> $GITHUB_STEP_SUMMARY || echo "No Swift frameworks" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ App bundle not found!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      
      - name: Upload .app bundle
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.setup.outputs.app-name }}-${{ inputs.ui-framework }}-${{ inputs.dependency-manager }}
          path: ${{ inputs.working-directory }}/dist/${{ needs.setup.outputs.app-name }}.app
          retention-days: 30
  
  # ãƒ†ã‚¹ãƒˆ
  test:
    name: Run Tests
    runs-on: ${{ inputs.runs-on }}
    needs: [setup, dependencies]
    if: inputs.run-tests
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ inputs.xcode-version }}
      
      - name: Install dependencies
        run: |
          if [ "${{ inputs.dependency-manager }}" = "cocoapods" ]; then
            sudo gem install cocoapods
            pod install --repo-update
          else
            if [ "${{ needs.setup.outputs.project-type }}" = "workspace" ]; then
              xcodebuild -resolvePackageDependencies -workspace ${{ inputs.project-path }} -scheme ${{ inputs.scheme }}
            else
              xcodebuild -resolvePackageDependencies -project ${{ inputs.project-path }} -scheme ${{ inputs.scheme }}
            fi
          fi
      
      - name: Run unit tests
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.setup.outputs.project-type }}" = "workspace" ]; then
            BUILD_CMD="-workspace ${{ inputs.project-path }}"
          else
            BUILD_CMD="-project ${{ inputs.project-path }}"
          fi
          
          xcodebuild test \
            $BUILD_CMD \
            -scheme ${{ inputs.scheme }} \
            -destination 'platform=macOS' \
            | xcpretty || true
          
          echo "âœ… Tests completed" >> $GITHUB_STEP_SUMMARY
  
  # DMGä½œæˆ
  package:
    name: Create Distribution Package
    runs-on: ${{ inputs.runs-on }}
    needs: [setup, build]
    if: inputs.create-dmg
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download .app bundle
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.app-name }}-${{ inputs.ui-framework }}-${{ inputs.dependency-manager }}
          path: ${{ inputs.working-directory }}/dist
      
      - name: Install create-dmg
        run: |
          brew install create-dmg 2>/dev/null || true
      
      - name: Create DMG
        run: |
          echo "## ðŸ“€ Distribution Packages" >> $GITHUB_STEP_SUMMARY
          
          APP_NAME="${{ needs.setup.outputs.app-name }}"
          
          # DMGä½œæˆ
          create-dmg \
            --volname "$APP_NAME" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "dist/$APP_NAME.dmg" \
            "dist/$APP_NAME.app" || \
          (cd dist && zip -r "$APP_NAME.zip" "$APP_NAME.app")
          
          # ã‚µã‚¤ã‚ºè¡¨ç¤º
          ls -lh dist/*.dmg dist/*.zip 2>/dev/null | awk '{print "- "$9": "$5}' >> $GITHUB_STEP_SUMMARY || true
      
      - name: Upload distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.setup.outputs.app-name }}-installer
          path: |
            ${{ inputs.working-directory }}/dist/*.dmg
            ${{ inputs.working-directory }}/dist/*.zip
          retention-days: 30
  
  # ã‚µãƒžãƒªãƒ¼
  summary:
    name: Build Summary
    runs-on: ${{ inputs.runs-on }}
    needs: [setup, build, test, package]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## âœ… Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package | ${{ needs.package.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
