# C++ Game Development & Graphics Example
# ã‚²ãƒ¼ãƒ é–‹ç™ºãƒ»ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å‘ã‘æœ€é©åŒ–
# OpenGL/Vulkan/Metalå¯¾å¿œã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹é‡è¦–

name: C++ Game & Graphics CI/CD

on:
  push:
    branches: [main, develop, feature/*, graphics/*]
  pull_request:
  workflow_dispatch:

jobs:
  # ã‚²ãƒ¼ãƒ ãƒ»ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ï¼‰
  build-game:
    uses: tomoya-cicd/github-actions-workflows/.github/workflows/c-cpp-cicd.yml@main
    
    with:
      # è¨€èªžè¨­å®š
      language: 'cpp'
      cpp-standard: 'c++20'  # ãƒ¢ãƒ€ãƒ³C++ã§ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ç°¡æ½”åŒ–
      
      # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©
      compiler: 'clang'  # LLVMã®é«˜åº¦ãªæœ€é©åŒ–
      
      # ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 
      build-system: 'cmake'
      cmake-options: |
        -DCMAKE_BUILD_TYPE=Release
        -DENABLE_OPENGL=ON
        -DENABLE_VULKAN=ON
        -DENABLE_METAL=ON
        -DENABLE_AVX2=ON
        -DENABLE_SIMD=ON
        -DCMAKE_CXX_FLAGS="-march=native -mtune=native -flto -ffast-math -DNDEBUG"
        -DCMAKE_EXE_LINKER_FLAGS="-flto"
        -DBUILD_SHARED_LIBS=OFF
        -DENABLE_PROFILING=ON
      
      # æœ€é©åŒ–ãƒ¬ãƒ™ãƒ«
      optimization-level: 'O3'  # æœ€å¤§é€Ÿåº¦æœ€é©åŒ–
      
      # ãƒ†ã‚¹ãƒˆ
      run-tests: true
      test-command: 'ctest --output-on-failure --parallel 4'
      
      # é™çš„è§£æž
      run-static-analysis: true
      run-valgrind: false  # ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚¢ãƒ—ãƒªã§ã¯é‡ã„
      
      # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆAPIå‘ã‘ï¼‰
      generate-docs: true
      
      # ãƒ©ãƒ³ãƒŠãƒ¼
      runs-on: 'self-hosted'  # Mac Studioï¼ˆMetal GPUæ´»ç”¨ï¼‰
  
  # ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  graphics-benchmark:
    needs: build-game
    runs-on: self-hosted
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-native
      
      - name: GPU information
        run: |
          echo "## ðŸŽ® Graphics Performance Test" >> $GITHUB_STEP_SUMMARY
          echo "### GPU Information" >> $GITHUB_STEP_SUMMARY
          
          # Mac Studioã®GPUæƒ…å ±å–å¾—
          system_profiler SPDisplaysDataType | grep -E "Chipset Model|VRAM" >> $GITHUB_STEP_SUMMARY || true
      
      - name: Run graphics benchmarks
        run: |
          if [ -x "build/graphics_benchmark" ]; then
            echo "### Benchmark Results" >> $GITHUB_STEP_SUMMARY
            
            # ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
            ./build/graphics_benchmark \
              --resolution=1920x1080 \
              --vsync=off \
              --duration=60 \
              --format=markdown >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Performance Metrics" >> $GITHUB_STEP_SUMMARY
            echo "- Target: 60 FPS" >> $GITHUB_STEP_SUMMARY
            echo "- Resolution: 1920x1080" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Shader compilation test
        run: |
          echo "### Shader Compilation" >> $GITHUB_STEP_SUMMARY
          
          # ã‚·ã‚§ãƒ¼ãƒ€ãƒ¼ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
          if command -v glslangValidator &> /dev/null; then
            shader_count=$(find shaders -name "*.vert" -o -name "*.frag" | wc -l)
            echo "- Total shaders: $shader_count" >> $GITHUB_STEP_SUMMARY
            
            # GLSLæ¤œè¨¼
            find shaders -name "*.vert" -o -name "*.frag" | while read shader; do
              glslangValidator "$shader" && echo "âœ… $(basename $shader)" || echo "âŒ $(basename $shader)"
            done >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Render test screenshots
        run: |
          if [ -x "build/render_test" ]; then
            mkdir -p screenshots
            ./build/render_test --headless --screenshot screenshots/
            
            echo "### Render Tests" >> $GITHUB_STEP_SUMMARY
            ls -1 screenshots/*.png 2>/dev/null | wc -l | xargs -I {} echo "- Screenshots generated: {}" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: render-screenshots
          path: screenshots/
          retention-days: 7
  
  # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°
  performance-profile:
    needs: build-game
    runs-on: self-hosted
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries-native
      
      - name: CPU profiling
        run: |
          echo "## ðŸ“Š Performance Profiling" >> $GITHUB_STEP_SUMMARY
          
          # Instrumentsã§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ï¼ˆMacï¼‰
          if command -v instruments &> /dev/null; then
            echo "### CPU Profile" >> $GITHUB_STEP_SUMMARY
            # Instrumentsã‚’ä½¿ã£ãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°
            # instruments -t "Time Profiler" -D profile.trace ./build/game
            echo "- Profiling data generated" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Memory profiling
        run: |
          if [ -x "build/game" ]; then
            echo "### Memory Usage" >> $GITHUB_STEP_SUMMARY
            
            # ã‚²ãƒ¼ãƒ å®Ÿè¡Œæ™‚ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æ¸¬å®š
            /usr/bin/time -l ./build/game --benchmark-mode 2>&1 | \
              grep -E "maximum resident set size" | \
              awk '{printf "- Peak Memory: %.2f MB\n", $1/1024/1024}' >> $GITHUB_STEP_SUMMARY || true
          fi
  
  # ã‚¢ã‚»ãƒƒãƒˆæ¤œè¨¼
  asset-validation:
    runs-on: self-hosted
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate game assets
        run: |
          echo "## ðŸŽ¨ Asset Validation" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ†ã‚¯ã‚¹ãƒãƒ£ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          if [ -d "assets/textures" ]; then
            echo "### Textures" >> $GITHUB_STEP_SUMMARY
            texture_count=$(find assets/textures -name "*.png" -o -name "*.jpg" | wc -l)
            total_size=$(du -sh assets/textures | cut -f1)
            echo "- Count: $texture_count" >> $GITHUB_STEP_SUMMARY
            echo "- Total size: $total_size" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
          if [ -d "assets/models" ]; then
            echo "### 3D Models" >> $GITHUB_STEP_SUMMARY
            model_count=$(find assets/models -name "*.obj" -o -name "*.fbx" -o -name "*.gltf" | wc -l)
            echo "- Count: $model_count" >> $GITHUB_STEP_SUMMARY
          fi
          
          # ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
          if [ -d "assets/audio" ]; then
            echo "### Audio Files" >> $GITHUB_STEP_SUMMARY
            audio_count=$(find assets/audio -name "*.wav" -o -name "*.ogg" -o -name "*.mp3" | wc -l)
            echo "- Count: $audio_count" >> $GITHUB_STEP_SUMMARY
          fi
